<include file="public:header" />

<!--添加文章-->

<form id="info_form" action="{:U('article/add')}" method="post" enctype="multipart/form-data">

<div class="pad_lr_10">

	<div class="col_tab">

		<ul class="J_tabs tab_but cu_li">

			<li class="current">{:L('article_basic')}</li>

			<li>{:L('article_seo')}</li>

			<li>其他信息</li>

		</ul>

		<div class="J_panes">

			<div class="content_list pad_10">

				<table width="100%" cellspacing="0" class="table_form">

					<tr>

						<th width="120">{:L('article_cateid')} :</th>

						<td><select class="J_cate_select mr10" data-pid="0" data-uri="{:U('article_cate/ajax_getchilds')}" data-selected=""></select><input type="hidden" name="cate_id" id="J_cate_id" value="" /></td>

					</tr>


					<tr>

				<th width="120">所属分类 :</th>

                <td><select class="J_item_cate_select mr10" data-pid="0" data-uri="{:U('item_cate/ajax_getchilds', array('type'=>0))}" data-selected=""></select>

				<input type="hidden" name="item_cate_id" id="J_item_cate_id" value="" /><b style="color: orangered; font-weight: bold;">* 必填项</b>

				&nbsp;<input class="input-text" type="text" name="search_cate" id ="search_cate" value="" placeholder="搜索分类" /> </td>

			</tr>

		            <tr>

						<th>{:L('article_title')} :</th>

						<td>

							<input type="text" name="title" id="J_title" class="input-text" size="30">

					        <input type="hidden" value="" name="color" id="J_color">

					        <a href="javascript:;" class="color_picker_btn"><img class="J_color_picker" data-it="J_title" data-ic="J_color" src="__STATIC__/images/color.png"></a>

							<b style="color: orangered; font-weight: bold;">* 必填项</b>

		                </td>

					</tr>

					<tr>

						<th>副标题 :</th>

						<td>

							<input type="text" name="otitle" id="J_otitle" class="input-text" size="30">

		                </td>

					</tr>

					<tr>

						<th width="120">商品来源 :</th>

		                <td>

						<select name="orig_id" id="orig_id">

		            	<volist name="orig_list" id="val">

		            	<option value="{$val.id}">{$val.name}</option>

		            	</volist>

		            	</select></td>

					</tr>

		            <tr>

						<th>{:L('tag')} :</th>

						<td>

		                	<input type="text" name="tags" id="J_tags" class="input-text" size="50">

		                    <input type="button" value="{:L('auto_get')}" id="J_gettags" name="tags_btn" class="btn">

		                </td>

					</tr>

		            <tr>

						<th>{:L('author')} :</th>

						<td><input type="text" name="author" id="author" class="input-text" size="30" value="{$author}"></td>

					</tr>
<!--
		            <tr>

						<th>{:L('article_img')} :</th>

						<td><input type="file" name="img" id="img" class="input-text"  style="width:200px;" /></td>

		 			</tr>
-->
		 			 <tr>

				<th>{:L('article_img')} :</th>

		   
				<td>
				<div class="w_tpk"><img id="btn_img" src="<if condition="$item['img'] neq '' && $item['img']!='http:' ">{$item['img']}<else/>/images/jia_pic.png</if>"/>

		  </div>
		  <div style="margin-top:90px">    <p style="color:#999999;">支持小于300k格式为jpg、jpeg、png的图片，截图请注意商品显示完全</p>
		 		  </div>
		   <div class="w_cczx">

            			<em>上传照片</em>
  		<input type="hidden" name="img" value="{$item['img']}" id="img"/>

		  <input type="file" name="J_img" id="J_img" class="w_bl_in2"  />
		  
				<input type="file"  name="img"  id="img" class="w_bl_in2" style="display: none" /> 
				
		</div>
		<input style="top:15px;left: 15px;"  type="button" name="J_img_d" class="btn" id="J_img_d"   value="选取第一张" />
		<input type="text" style="top:15px;left: 15px;position:relative" size="80" id="R_img" name="img_usb"   placeholder="远程图片地址" class="input-text" value="">
				 </td>

 			</tr>


					<tr>

						<th>{:L('publish')} :</th>

		 				<td>

		                	<label><input type="radio" name="status" class="radio_style" value="1"> {:L('yes')} </label>&nbsp;&nbsp;

							<label><input type="radio" name="status" class="radio_style" value="0" checked="checked"> {:L('no')}</label>

						</td>

					</tr>

                    <tr>

						<th>{:L('article_abst')} :</th>

						<td><textarea name="intro" id="abst" style="width:67%;height:50px;resize:none;"></textarea></td>

					</tr>

		            <tr>

						<th>详细内容 :</th>

		                <td>

							<script id="content" name="info" type="text/plain" style="width:80%;height:300px;"></script>

							<!--<textarea name="info" id="info" style="width:68%;height:400px;visibility:hidden;resize:none;"></textarea>--></td>

					</tr>

					<tr>

						<th>发布时间 :</th>

						<td>

						<input type="text" name="add_time" id="add_time" size="25" class="input-text" value=""></td>

					</tr>

				</table>

			</div>

			<div class="content_list pad_10 hidden">

				<table width="100%" cellspacing="0" class="table_form">

					<tr>

						<th width="120">{:L('seo_title')} :</th>

		 				<td><input type="text" name="seo_title" id="seo_title" class="input-text" size="60"></td>

					</tr>

					<tr>

						<th>{:L('seo_keys')} :</th>

						<td><input type="text" name="seo_keys" id="seo_keys" class="input-text" size="60"></td>

					</tr>

					<tr>

						<th>{:L('seo_desc')} :</th>

						<td><textarea name="seo_desc" id="seo_desc" cols="80" rows="8"></textarea></td>

					</tr>

				</table>

			</div>

			<div class="content_list pad_10 hidden">

				<table width="100%" cellspacing="0" class="table_form">					

					<tr>

						<th>商品质量 :</th>

						<td>

						<select name="g_zl" id="g_zl">

						<option value="5">★★★★★</option>

						<option value="4">★★★★</option>

						<option value="3">★★★</option>

						<option value="2">★★</option>

						<option value="1">★</option>

						</select>

						</td>

					</tr>

					<tr>

						<th>配送服务 :</th>

						<td>

						<select name="g_fw" id="g_fw">

						<option value="5">★★★★★</option>

						<option value="4">★★★★</option>

						<option value="3">★★★</option>

						<option value="2">★★</option>

						<option value="1">★</option>

						</select></td>

					</tr>

					<tr>

						<th>客户服务 :</th>

						<td>

						<select name="g_kh" id="g_kh">

						<option value="5">★★★★★</option>

						<option value="4">★★★★</option>

						<option value="3">★★★</option>

						<option value="2">★★</option>

						<option value="1">★</option>

						</select></td>

					</tr>

					<tr>

						<th>文章属性 :</th>

						<td><label><input type="checkbox" name="isbest" value="1"> 精华</label> <label><input type="checkbox" name="ishot" value="1"> 热门</label> <label><input type="checkbox" name="istop" value="1"> 置顶</label></td>

					</tr>

				</table>

			</div>

        </div>

		<div class="mt10"><input type="button" value="{:L('submit')}" id="dosubmit" onclick="ajx()" name="dosubmit" class="btn btn_submit" style="margin:0 0 10px 100px;"><br /><br /><br /></div>

	</div>

</div>

</form>
<style>

	#clipArea {

		margin: 20px;

		height: 300px;}

	#car{

		display: block;

		left: 50%;

		top: 50%;

		width: 600px;

		height: 300px;

		position: fixed;

		margin-left: -300px;

		margin-top: -150px;

		display: none;

            z-index: 999;

	}
	a.cates {
    margin-left: 4px;
}

</style>

<div id="car">

	<div id="clipArea"></div>

	<button id="clipBtn">裁剪</button>

	<button id="J_img_close">关闭</button>

	<p class="clipArea_tips"><span>*</span>滑动鼠标滑轮，可进行裁剪区域缩放。</p>

</div>



<include file="public:footer" />

<script src="__STATIC__/js/jquery/plugins/colorpicker.js"></script>
<script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.config.js"></script>

<script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.all.min.js"> </script>

<script type="text/javascript" charset="utf-8" src="/ueditor/lang/zh-cn/zh-cn.js"></script>

<script>

	var ue = UE.getEditor('content');

$('.J_cate_select').cate_select('请选择');
$('.J_item_cate_select').item_cate_select('请选择');
$("#search_cate").change(function(){
		//alert($(this).val());
		if($(this).val() !=""){
			$.post('{:U("item/ajax_getcates")}', {cate:$(this).val()}, function(result){

			if(result.status == 1){
				$(".cates").remove();
				for(var i=0;i<result.data.length;i++){
				$("#search_cate").after("<a class='cates' spid=" + result.data[i].spid + ">"+result.data[i].name + "</a>");
			}

			}else{
				$(".cates").remove();
				$.pinphp.tip({content:result.msg});

			}

		},'json');
		}
	});
$(".cates").live("click",function(){
		var spid = $(this).attr("spid");
		$('.J_item_cate_select').attr("data-selected",0);
		$(".J_item_cate_select").item_cate_select();
		$('.J_item_cate_select').attr("data-selected",spid);
		$(".J_item_cate_select").item_cate_select();
	});

$(function() {


	$('ul.J_tabs').tabs('div.J_panes > div');



	//颜色选择器

	$('.J_color_picker').colorpicker();



	//自动获取标签

	$('#J_gettags').live('click', function() {

		var title = $.trim($('#J_title').val());

		if(title == ''){

			$.pinphp.tip({content:lang.article_title_isempty, icon:'alert'});

			return false;

		}

		$.getJSON('{:U("article/ajax_gettags")}', {title:title}, function(result){

			if(result.status == 1){

				$('#J_tags').val(result.data);

			}else{

				$.pinphp.tip({content:result.msg});

			}

		});

	});

	

});

	function ajx(){





		$.ajax({

			cache: true,

			type: "POST",

			url:"{:U('article/add')}",

			data:$('#info_form').serialize(),// 你的formid

			async: false,

			dataType: "json",

			error: function(request) {

				alert("Connection error");

			},

			success: function(data) {

				alert(data.msg);

			}

		});

	}

</script>
<script src="/js/ajaxfileupload.js" type="text/javascript"></script>
<link rel="stylesheet" href="__STATIC__/js/calendar/calendar-blue.css"/>

<script src="__STATIC__/js/calendar/calendar.js"></script>
<script src="/js/car1.6/iscroll-zoom.js"></script>

<script src="/js/car1.6/hammer.js"></script>

<script src="/js/car1.6/lrz.all.bundle.js"></script>

<script src="/js/car1.6/PhotoClip.js"></script>

<script>

	var pc = new PhotoClip('#clipArea', {
		size: [200, 200],
		outputSize: [600, 600],
		//adaptive: ['60%', '80%'],
		file: '#file',
		view: '#view',
		ok: '#clipBtn',
		//img: 'img/mm.jpg',
		loadStart: function() {
			console.log('开始读取照片');
		},
		loadComplete: function() {
			console.log('照片读取完成');
		},
		done: function(dataURL) {
			$('#clipBtn').html('保存中....');

			$.post('/index.php?m=item&a=uploadimg1',{data:dataURL},function(result){

				if(result.status ==1){

					$('#clipBtn').html('裁剪');

					$('#btn_img').attr('src',result.data);

					$('#img').val(result.data);

					$('#car').hide();

				}

			},'json');
		},
		fail: function(msg) {
			alert(msg);
		}
	});

	$('#J_img_d').click('change',function () {
		var content = ue.getContent(); 
		var pattern =/<img(.*?)src=\"(.*?)\"/;
		var imgs=pattern.exec(content);
		if(imgs !=null && imgs[2].substring(0,13)== "/ueditor/php/"){
		pc.load(imgs[2]);
		$('#car').show();
		}
		else{
			$.get('/ueditor/php/controller.php?action=catchimage&transfer=1&source[]='+imgs[2],{},function(result){

				if(result.state =="SUCCESS"){
					img=result.list[0].url;
					pc.load(img);
					$('#car').show();

				}
				else{
					alert("找不到图片");
					$('#car').hide();
				}

			},'json');
		
		}
		

	});

	$('#J_img_close').click('change',function () {

		$('#car').hide();

	});

	$("#btn_img").click(function(){

	$("#J_img").trigger("click");

});

	$('#J_img').live('change',function () {

		$('#car').show();

	});

	$("#J_img").live('change',function () {

	ajaxFileUpload();

});

var PINER = {
    root: "__ROOT__",
    uid: "<?php echo $visitor['id'];?>", 
    async_sendmail: "<?php echo $async_sendmail;?>",
    config: {
        wall_distance: "<?php echo C('pin_wall_distance');?>",
        wall_spage_max: "<?php echo C('pin_wall_spage_max');?>"
    },
    //URL
    url: {}
};

function ajaxFileUpload() {


	$.ajaxFileUpload

	(

		{

			url: PINER.root + '/?m=item&a=uploadimg', //用于文件上传的服务器端请求地址

			secureuri: false, //是否需要安全协议，一般设置为false

			fileElementId: 'J_img', //文件上传域的ID

			dataType: 'json', //返回值类型 一般设置为json

			success: function (result, status)  //服务器成功响应处理函数

			{

				if(result.status =='1'){
					pc.load(result.data);

					

				}

			},

			error: function (data, status, e)//服务器响应失败处理函数

			{

				tips(e,0);

			}

		}

	)

	return false;

}
</script>

<script>

Calendar.setup({

	inputField : "add_time",

	ifFormat   : "%Y-%m-%d %H:%M",

	showsTime  : true,

	timeFormat : "24"

});

</script>


</body>

</html>